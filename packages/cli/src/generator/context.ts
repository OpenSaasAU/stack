import type { OpenSaaSConfig } from '@opensaas/core'
import * as fs from 'fs'
import * as path from 'path'

/**
 * Generate context factory that abstracts Prisma client from developers
 *
 * Creates a simple API with getContext() and getContextWithSession(session)
 * that internally handles Prisma singleton and config imports.
 */
export function generateContext(config: OpenSaaSConfig): string {
  return `/**
 * Auto-generated context factory
 *
 * This module provides a simple API for creating OpenSaaS contexts.
 * It abstracts away Prisma client management and configuration.
 *
 * DO NOT EDIT - This file is automatically generated by 'pnpm generate'
 */

import { getContext as getOpensaasContext } from '@opensaas/core'
import { PrismaClient } from './prisma-client'
import config from '../opensaas.config'

// Internal Prisma singleton - managed automatically
const globalForPrisma = globalThis as unknown as { prisma: PrismaClient | undefined }
const prisma = globalForPrisma.prisma ?? new PrismaClient()
if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma

/**
 * Get OpenSaaS context with optional session
 *
 * @param session - Optional session object (structure defined by your application)
 *
 * @example
 * \`\`\`typescript
 * // Anonymous access
 * const context = await getContext()
 * const posts = await context.db.post.findMany()
 *
 * // Authenticated access
 * const context = await getContext({ userId: 'user-123' })
 * const myPosts = await context.db.post.findMany()
 * \`\`\`
 */
export async function getContext(session?: any) {
  return await getOpensaasContext(config, prisma, session ?? null)
}
`
}

/**
 * Write context factory to file
 */
export function writeContext(config: OpenSaaSConfig, outputPath: string): void {
  const content = generateContext(config)

  // Ensure directory exists
  const dir = path.dirname(outputPath)
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true })
  }

  fs.writeFileSync(outputPath, content, 'utf-8')
}
