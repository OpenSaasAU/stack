# create-opensaas-app

CLI tool for scaffolding new OpenSaas Stack applications.

## Purpose

Creates new OpenSaas Stack projects from embedded templates, following the `npm create` convention. Provides both interactive prompts and CLI flags for flexibility.

## Architecture

### Template-Based Approach

Unlike the old `opensaas init` which used template strings, this package **copies working examples**:

1. **Source of Truth**: `examples/starter` and `examples/starter-auth`
2. **Build Step**: Templates copied into package during build
3. **Runtime**: Templates embedded in published npm package
4. **User Flow**: CLI copies template and customizes it

**Benefits:**

- Templates are always tested (they're real working examples)
- No template string maintenance
- Changes to examples automatically propagate
- Can test templates independently

### Build Process

```bash
pnpm build
# 1. TypeScript compiles src/ → dist/
# 2. chmod +x dist/index.js (make executable)
# 3. copy-templates.js runs
# 4. Templates copied from ../../examples/ → templates/
# 5. Package ready for npm publish
```

### Package Structure

```
packages/create-opensaas-app/
├── src/
│   ├── index.ts              # Main CLI (has #!/usr/bin/env node)
│   └── copy-templates.ts     # Build script to copy templates
├── dist/                     # Generated by TypeScript
│   ├── index.js              # Executable entry point
│   └── copy-templates.js     # Build-time script
├── templates/                # Generated by copy-templates
│   ├── basic/                # From examples/starter
│   └── with-auth/            # From examples/starter-auth
├── package.json
├── tsconfig.json
└── README.md
```

## Key Files

### `src/index.ts`

Main CLI logic with:

- Interactive prompts (project name, auth yes/no)
- CLI flag parsing (`--with-auth`)
- Input validation (lowercase, numbers, hyphens only)
- Template copying
- File customization (package.json, README.md)
- Colored output with chalk/ora

**Entry point:** Has `#!/usr/bin/env node` shebang which TypeScript preserves

### `src/copy-templates.ts`

Build-time script that:

- Copies `examples/starter` → `templates/basic`
- Copies `examples/starter-auth` → `templates/with-auth`
- Excludes build artifacts (node_modules, .next, etc.)
- Runs during `pnpm build`

### `package.json`

**Important fields:**

```json
{
  "type": "module", // ESM modules
  "bin": {
    "create-opensaas-app": "./dist/index.js" // Points directly to compiled TS
  },
  "files": [
    "dist", // Compiled TypeScript
    "templates" // Embedded templates
  ]
}
```

**No `bin/` directory needed** - package.json points directly to compiled TypeScript

## Templates

### Basic Template (`templates/basic`)

**Source:** `examples/starter`

**Includes:**

- User + Post models with relationships
- Admin UI at `/admin`
- SQLite database (easy local setup)
- Access control examples
- TypeScript + Next.js 16

### Auth Template (`templates/with-auth`)

**Source:** `examples/starter-auth`

**Includes:**

- Everything from basic template
- Better-auth integration
- Sign in/sign up pages
- Session management
- OAuth provider setup instructions

## CLI Usage

### Interactive Mode

```bash
npm create opensaas-app@latest
# Prompts for:
# - Project name
# - Include authentication? (y/n)
```

### With Flags

```bash
npm create opensaas-app@latest my-app           # Basic template
npm create opensaas-app@latest my-app --with-auth   # Auth template
```

## Template Customization

After copying the template, the CLI customizes:

1. **package.json**: Updates `name` field to project name
2. **README.md**: Replaces first h1 with project name

**Files NOT customized** (kept as-is from template):

- `opensaas.config.ts` - User will customize themselves
- `.env` / `.env.example` - Template values are appropriate
- All other files

## Excluded Files

When copying templates, these are excluded:

- `node_modules/` - User will run `pnpm install`
- `.next/` - Build artifact
- `.turbo/` - Build artifact
- `.opensaas/` - Generated by `pnpm generate`
- `prisma/schema.prisma` - Generated by `pnpm generate`
- `dev.db` - SQLite file (will be created by user)
- `tsconfig.tsbuildinfo` - Build artifact
- `next-env.d.ts` - Generated by Next.js
- `pnpm-lock.yaml` - User will generate their own

## Maintenance

### When to Rebuild Templates

Run `pnpm build` after updating:

- `examples/starter` (source for basic template)
- `examples/starter-auth` (source for auth template)

**Before publishing:**

```bash
cd packages/create-opensaas-app
pnpm build  # Ensures templates are fresh
npm publish
```

### Updating Templates

**IMPORTANT:** Don't edit `templates/` directly!

1. Update source example: `examples/starter` or `examples/starter-auth`
2. Test the example works
3. Rebuild package: `pnpm build`
4. Templates automatically updated

### Adding New Templates

To add a new template option:

1. Create new example in `examples/` (e.g., `examples/starter-fullstack`)
2. Update `src/copy-templates.ts`:
   ```typescript
   await copyTemplate('starter-fullstack', 'fullstack')
   ```
3. Update `src/index.ts` to add new CLI option
4. Rebuild package

## TypeScript Configuration

### Shebang Preservation

TypeScript **preserves** the `#!/usr/bin/env node` shebang from source files. The compiled `dist/index.js` includes it automatically.

### Executable Permission

The build script runs `chmod +x dist/index.js` to ensure the file is executable when published to npm.

### Module System

Uses ESM modules (`"type": "module"`):

- All imports use `.js` extensions (not `.ts`)
- Works with `import` syntax
- Compatible with modern Node.js

## Publishing Workflow

### Pre-Publish Checklist

- [ ] Source examples (`examples/starter`, `examples/starter-auth`) are tested and working
- [ ] Run `pnpm build` to generate fresh templates
- [ ] Test locally: `node dist/index.js test-app`
- [ ] Verify templates copied correctly
- [ ] Version bumped via changesets

### Test Locally Before Publishing

```bash
cd packages/create-opensaas-app
pnpm build

# Test the CLI locally
cd /tmp
node /path/to/packages/create-opensaas-app/dist/index.js my-test-app
cd my-test-app
pnpm install
pnpm generate
pnpm dev
```

### Publishing

Uses changesets for version management:

```bash
pnpm changeset
# Select create-opensaas-app
# Choose version bump type
# Commit changeset file

# When ready to release, changesets CI will:
# - Bump version
# - Run pnpm build (includes template copying)
# - Publish to npm
```

## Common Patterns

### Validation

Project names must match: `/^[a-z0-9-]+$/`

**Valid:**

- `my-app`
- `my-saas-2024`
- `company-admin`

**Invalid:**

- `My-App` (uppercase)
- `my_app` (underscores)
- `my app` (spaces)

### Prompts

Uses `prompts` library for interactive input:

```typescript
const response = await prompts({
  type: 'confirm',
  name: 'withAuth',
  message: 'Include authentication? (Better-auth)',
  initial: false,
})
```

Supports cancellation (Ctrl+C) with graceful exit.

### File Operations

Uses `fs-extra` for:

- `fs.copy()` - Copy template directory
- `fs.pathExists()` - Check if directory exists
- `fs.readJSON()` / `fs.writeJSON()` - Parse and update package.json
- `fs.readFile()` / `fs.writeFile()` - Update README

## Dependencies

### Runtime Dependencies

- **prompts** - Interactive CLI prompts
- **chalk** - Colored terminal output
- **ora** - Loading spinners

### Dev Dependencies

- **typescript** - TypeScript compiler
- **fs-extra** - Enhanced file operations
- **@types/** - Type definitions

## Error Handling

### Common Errors

**Directory already exists:**

```typescript
if (await fs.pathExists(targetDir)) {
  spinner.fail(`Directory ${projectName} already exists`)
  process.exit(1)
}
```

**Template not found:**

```typescript
if (!(await fs.pathExists(templateDir))) {
  spinner.fail(`Template ${template} not found`)
  console.error('Run "pnpm build" to generate templates')
  process.exit(1)
}
```

**Invalid project name:**

```typescript
if (!/^[a-z0-9-]+$/.test(projectName)) {
  console.error('Project name must only contain lowercase letters...')
  process.exit(1)
}
```

## Integration Points

### With Examples

- `examples/starter` → source of truth for basic template
- `examples/starter-auth` → source of truth for auth template
- Changes to examples propagate to templates via build

### With Documentation

- Quick-start guide references `npm create opensaas-app`
- README shows both interactive and flag-based usage
- Deployment guide assumes apps created with this CLI

### With Publishing

- Changesets handles versioning
- Templates must be built before publishing
- npm package includes `dist/` and `templates/` folders

## Future Enhancements

Potential improvements (not currently implemented):

- **More templates**: Full-stack, e-commerce, etc.
- **Custom template URLs**: `--template https://github.com/...`
- **Monorepo support**: `--workspace` flag
- **Git initialization**: Auto `git init` and first commit
- **Package manager detection**: Auto-detect npm/pnpm/yarn
- **Template versioning**: Allow `@latest`, `@canary`, etc.

## Best Practices

1. **Always update examples first** - Never edit `templates/` directly
2. **Test examples independently** - Ensure they work before building
3. **Rebuild before publishing** - Fresh templates for every release
4. **Keep bin file minimal** - All logic in `src/index.ts`
5. **Preserve shebangs** - TypeScript automatically handles this
6. **Validate user input** - Prevent common mistakes
7. **Provide clear next steps** - Show users what to run after creation

## Troubleshooting

### Templates not found during development

**Issue:** Running CLI shows "Template not found"

**Solution:** Run `pnpm build` to generate templates from examples

### Changes to examples not reflected

**Issue:** Updated `examples/starter` but CLI uses old version

**Solution:** Run `pnpm build` to re-copy templates

### Permission denied when running CLI

**Issue:** `dist/index.js` not executable

**Solution:** Build script should run `chmod +x`, verify with `ls -la dist/index.js`

### TypeScript errors during build

**Issue:** Type errors in `src/index.ts`

**Solution:** Fix TypeScript errors - all types must be properly defined (no `any`, use proper types for prompts responses, etc.)
