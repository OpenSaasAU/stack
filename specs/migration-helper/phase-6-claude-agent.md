# Phase 6: Claude Code Agent Templates

## Task Overview

Create the template files that get generated in the user's `.claude/` directory when they run `opensaas migrate --with-ai`. These templates configure Claude Code to act as a migration assistant with access to the MCP tools.

## Context

### How Templates Are Used

When a user runs `opensaas migrate --with-ai`, the CLI:

1. Analyzes their project (Phase 1)
2. Creates `.claude/` directory structure
3. Generates `settings.json` with MCP server
4. Creates agent templates with project-specific context
5. Creates command templates

The templates include placeholders that get filled with project analysis data.

### Existing Claude Code Patterns

The monorepo has example Claude Code configuration at `.claude/`:

```
.claude/
├── settings.json              # MCP server registration
├── README.md                  # Project documentation for Claude
├── agents/
│   └── github-issue-creator.md # Specialized agent
└── commands/
    └── fix-e2e.md             # Custom command
```

**settings.json:**
```json
{
  "mcpServers": {
    "opensaas-stack": {
      "command": "opensaas",
      "args": ["mcp", "start"],
      "disabled": false
    }
  }
}
```

**Agent format:**
```markdown
You are [agent name].

## Context

[project-specific information]

## Your Role

[what the agent should do]

## Available Tools

[list of MCP tools]

## Guidelines

[how to behave]
```

---

## Requirements

### 1. Template Generator

**Modify:** `packages/cli/src/commands/migrate.ts`

The `setupClaudeCode` function should generate templates with:
- Project-specific analysis data
- Dynamic model lists
- Appropriate MCP tool references
- Clear instructions for Claude

### 2. Template Files

Generate these files:

| File | Purpose |
|------|---------|
| `.claude/settings.json` | MCP server registration |
| `.claude/README.md` | Project context for Claude |
| `.claude/agents/migration-assistant.md` | Main migration agent |
| `.claude/commands/analyze-schema.md` | Command to analyze schema |
| `.claude/commands/generate-config.md` | Command to generate config |
| `.claude/commands/validate-migration.md` | Command to validate config |

---

## Template Specifications

### 1. `.claude/settings.json`

```json
{
  "mcpServers": {
    "opensaas-migration": {
      "command": "npx",
      "args": ["@opensaas/stack-cli", "mcp", "start"],
      "disabled": false
    }
  }
}
```

**Notes:**
- Uses `npx` for portability (works without global install)
- Server name is `opensaas-migration` to distinguish from global server
- Can coexist with other MCP servers

### 2. `.claude/README.md`

Template with placeholders:

```markdown
# OpenSaaS Stack Migration

This project is being migrated to OpenSaaS Stack.

## Project Summary

- **Project Type:** {{PROJECT_TYPES}}
- **Database Provider:** {{PROVIDER}}
- **Models Detected:** {{MODEL_COUNT}}

### Models

{{MODEL_LIST}}

## Quick Start

Ask Claude: **"Help me migrate to OpenSaaS Stack"**

Claude will guide you through:
1. Reviewing your current schema
2. Configuring access control
3. Setting up authentication (optional)
4. Generating `opensaas.config.ts`

## Available Commands

| Command | Description |
|---------|-------------|
| `/analyze-schema` | View detailed schema analysis |
| `/generate-config` | Generate the config file |
| `/validate-migration` | Validate generated config |

## Resources

- [OpenSaaS Stack Documentation](https://stack.opensaas.au/)
- [Migration Guide](https://stack.opensaas.au/guides/migration)
- [GitHub Repository](https://github.com/OpenSaasAU/stack)

## Generated By

This migration was set up using:
```bash
npx @opensaas/stack-cli migrate --with-ai
```
```

### 3. `.claude/agents/migration-assistant.md`

```markdown
You are the OpenSaaS Stack Migration Assistant, helping users migrate their existing projects to OpenSaaS Stack.

## Project Context

**Project Type:** {{PROJECT_TYPES}}
**Database Provider:** {{PROVIDER}}
**Total Models:** {{MODEL_COUNT}}

### Detected Models

{{MODEL_DETAILS}}

## Your Role

Guide the user through a complete migration to OpenSaaS Stack:

1. **Analyze** their current project structure
2. **Explain** what OpenSaaS Stack offers (access control, admin UI, type safety)
3. **Guide** them through the migration wizard
4. **Generate** a working `opensaas.config.ts`
5. **Validate** the generated configuration
6. **Provide** clear next steps

## Available MCP Tools

### Schema Analysis
- `opensaas_introspect_prisma` - Analyze Prisma schema in detail
- `opensaas_introspect_keystone` - Analyze KeystoneJS config

### Migration Wizard
- `opensaas_start_migration` - Start the interactive wizard
- `opensaas_answer_migration` - Answer wizard questions

### Documentation
- `opensaas_search_migration_docs` - Search migration documentation
- `opensaas_get_example` - Get example code patterns

### Validation
- `opensaas_validate_feature` - Validate implementation

## Conversation Guidelines

### When the user says "help me migrate" or similar:

1. **Acknowledge** their project:
   > "I can see you have a {{PROJECT_TYPE}} project with {{MODEL_COUNT}} models. Let me help you migrate to OpenSaaS Stack!"

2. **Start the wizard** by calling:
   ```
   opensaas_start_migration({ projectType: "{{PROJECT_TYPE_LOWER}}" })
   ```

3. **Present questions naturally** - don't mention session IDs or technical details to the user

4. **Explain choices** - help them understand what each option means:
   - Access control patterns
   - Authentication options
   - Database configuration

5. **Show progress** - let them know how far along they are

6. **Generate the config** when complete and explain what was created

### When explaining OpenSaaS Stack:

Highlight these benefits:
- **Built-in access control** - Secure by default
- **Admin UI** - Auto-generated from your schema
- **Type safety** - Full TypeScript support
- **Prisma integration** - Uses familiar ORM
- **Plugin system** - Easy to extend

### When answering questions:

- Use `opensaas_search_migration_docs` to find accurate information
- Use `opensaas_get_example` to show code patterns
- Be honest if something isn't supported

### Tone

- Be encouraging and helpful
- Explain technical concepts simply
- Celebrate progress ("Great choice!", "Almost there!")
- Don't overwhelm with information

## Example Conversation

**User:** Help me migrate to OpenSaaS Stack

**You:** I can see you have a Prisma project with 5 models (User, Post, Comment, Tag, Category). OpenSaaS Stack will give you:

- Automatic admin UI for managing your data
- Built-in access control to secure your API
- Type-safe database operations

Let me start the migration wizard to configure your project...

[Call opensaas_start_migration]

**User:** [answers questions]

**You:** [Continue through wizard, explain each choice, generate final config]

## Error Handling

If something goes wrong:
1. Explain what happened in simple terms
2. Suggest alternatives or manual steps
3. Link to documentation for more help

## After Migration

Once the config is generated, guide them through:
1. Installing dependencies
2. Running `opensaas generate`
3. Running `prisma db push`
4. Starting their dev server
5. Visiting the admin UI
```

### 4. `.claude/commands/analyze-schema.md`

```markdown
Analyze the current project schema and provide a detailed breakdown.

## Instructions

1. Use `opensaas_introspect_prisma` or `opensaas_introspect_keystone` based on project type
2. Present the results in a clear, organized format
3. Highlight:
   - All models and their fields
   - Relationships between models
   - Potential access control patterns
   - Any issues or warnings

## Output Format

Present like this:

### Models Summary

| Model | Fields | Has Relations | Suggested Access |
|-------|--------|---------------|------------------|
| ... | ... | ... | ... |

### Detailed Analysis

[For each model, show fields and relationships]

### Recommendations

[Based on the schema, suggest access control patterns]
```

### 5. `.claude/commands/generate-config.md`

```markdown
Generate the opensaas.config.ts file for this project.

## Instructions

1. If migration wizard hasn't been started, start it:
   ```
   opensaas_start_migration({ projectType: "{{PROJECT_TYPE_LOWER}}" })
   ```

2. Guide the user through any remaining questions

3. When complete, display:
   - The generated config file
   - Dependencies to install
   - Next steps to run

4. Offer to explain any part of the generated config

## Quick Mode

If the user wants defaults, use these answers:
- preserve_database: true
- db_provider: {{PROVIDER}}
- enable_auth: {{HAS_AUTH}}
- default_access: "public-read-auth-write"
- admin_base_path: "/admin"
```

### 6. `.claude/commands/validate-migration.md`

```markdown
Validate the generated opensaas.config.ts file.

## Instructions

1. Check if opensaas.config.ts exists in the project root

2. If it exists, verify:
   - Syntax is valid TypeScript
   - All imports are correct
   - Database config is complete
   - Lists match original schema

3. Try running:
   ```bash
   npx @opensaas/stack-cli generate
   ```

4. Report any errors and suggest fixes

5. If validation passes, confirm next steps:
   - `npx prisma generate`
   - `npx prisma db push`
   - `pnpm dev`

## Common Issues

- Missing dependencies → suggest `pnpm add ...`
- Database URL not set → remind about .env file
- Type errors → suggest specific fixes
```

---

## Implementation

### Template Generator Function

Update `packages/cli/src/commands/migrate.ts`:

```typescript
interface TemplateData {
  projectTypes: string[]
  provider: string
  modelCount: number
  models: Array<{ name: string; fieldCount: number }>
  hasAuth: boolean
}

function generateTemplateContent(template: string, data: TemplateData): string {
  return template
    .replace(/\{\{PROJECT_TYPES\}\}/g, data.projectTypes.join(', '))
    .replace(/\{\{PROJECT_TYPE\}\}/g, data.projectTypes[0] || 'unknown')
    .replace(/\{\{PROJECT_TYPE_LOWER\}\}/g, (data.projectTypes[0] || 'prisma').toLowerCase())
    .replace(/\{\{PROVIDER\}\}/g, data.provider || 'sqlite')
    .replace(/\{\{MODEL_COUNT\}\}/g, String(data.modelCount))
    .replace(/\{\{HAS_AUTH\}\}/g, String(data.hasAuth))
    .replace(/\{\{MODEL_LIST\}\}/g, data.models.map(m => `- ${m.name} (${m.fieldCount} fields)`).join('\n'))
    .replace(/\{\{MODEL_DETAILS\}\}/g, data.models.map(m => `- **${m.name}**: ${m.fieldCount} fields`).join('\n'))
}

async function setupClaudeCode(cwd: string, analysis: ProjectAnalysis): Promise<void> {
  const claudeDir = path.join(cwd, '.claude')
  const agentsDir = path.join(claudeDir, 'agents')
  const commandsDir = path.join(claudeDir, 'commands')

  await fs.ensureDir(agentsDir)
  await fs.ensureDir(commandsDir)

  const templateData: TemplateData = {
    projectTypes: analysis.projectTypes,
    provider: analysis.provider || 'sqlite',
    modelCount: analysis.models?.length || 0,
    models: analysis.models || [],
    hasAuth: analysis.hasAuth || false,
  }

  // Generate settings.json
  const settings = {
    mcpServers: {
      'opensaas-migration': {
        command: 'npx',
        args: ['@opensaas/stack-cli', 'mcp', 'start'],
        disabled: false,
      },
    },
  }
  await fs.writeJSON(path.join(claudeDir, 'settings.json'), settings, { spaces: 2 })

  // Generate README
  const readmeTemplate = `... (from template above)`
  await fs.writeFile(
    path.join(claudeDir, 'README.md'),
    generateTemplateContent(readmeTemplate, templateData)
  )

  // Generate migration assistant agent
  const agentTemplate = `... (from template above)`
  await fs.writeFile(
    path.join(agentsDir, 'migration-assistant.md'),
    generateTemplateContent(agentTemplate, templateData)
  )

  // Generate commands
  const commands = {
    'analyze-schema.md': `... (from template above)`,
    'generate-config.md': `... (from template above)`,
    'validate-migration.md': `... (from template above)`,
  }

  for (const [filename, template] of Object.entries(commands)) {
    await fs.writeFile(
      path.join(commandsDir, filename),
      generateTemplateContent(template, templateData)
    )
  }
}
```

---

## Acceptance Criteria

1. **Directory Structure**
   - [ ] Creates `.claude/` directory
   - [ ] Creates `agents/` subdirectory
   - [ ] Creates `commands/` subdirectory

2. **settings.json**
   - [ ] Valid JSON format
   - [ ] Registers MCP server correctly
   - [ ] Uses npx for portability

3. **README.md**
   - [ ] Contains project summary
   - [ ] Lists detected models
   - [ ] Provides quick start instructions
   - [ ] Links to documentation

4. **migration-assistant.md**
   - [ ] Contains project context
   - [ ] Lists all MCP tools
   - [ ] Provides conversation guidelines
   - [ ] Includes example conversation
   - [ ] Has error handling guidance

5. **Command Templates**
   - [ ] analyze-schema.md provides clear instructions
   - [ ] generate-config.md guides through wizard
   - [ ] validate-migration.md checks generated config

6. **Template Variables**
   - [ ] All placeholders are replaced
   - [ ] Data matches actual project analysis
   - [ ] Handles missing data gracefully

---

## Testing

### Manual Testing

```bash
# Build CLI
cd packages/cli
pnpm build

# Test on a Prisma project
cd /path/to/prisma-project
npx @opensaas/stack-cli migrate --with-ai

# Verify files created
ls -la .claude/
cat .claude/settings.json
cat .claude/README.md
cat .claude/agents/migration-assistant.md
cat .claude/commands/analyze-schema.md

# Open in Claude Code and test
# 1. Ask "help me migrate"
# 2. Try /analyze-schema command
# 3. Try /generate-config command
```

### Verification Checklist

1. **Open project in Claude Code**
   - [ ] MCP server connects successfully
   - [ ] Tools appear in tool list

2. **Test migration assistant**
   - [ ] Responds to "help me migrate"
   - [ ] Uses correct MCP tools
   - [ ] Guides through wizard properly
   - [ ] Generates valid config

3. **Test commands**
   - [ ] `/analyze-schema` works
   - [ ] `/generate-config` works
   - [ ] `/validate-migration` works

4. **End-to-end**
   - [ ] Generated config is valid
   - [ ] `opensaas generate` succeeds
   - [ ] `prisma db push` succeeds
   - [ ] Admin UI works

---

## Notes

### Claude Code Behavior

- Claude Code reads `.claude/README.md` for project context
- Agents in `.claude/agents/` can be invoked by name
- Commands in `.claude/commands/` become slash commands
- MCP servers in `settings.json` are auto-connected

### Template Best Practices

1. **Keep templates readable** - Users may want to customize
2. **Include comments** - Explain what each section does
3. **Use markdown** - Claude renders it nicely
4. **Be specific** - Give Claude clear instructions
5. **Handle edge cases** - What if analysis is incomplete?

### Future Enhancements

- **Per-model agents** - Specialized agents for complex models
- **Custom commands** - User-defined migration commands
- **Prompt library** - Reusable prompt snippets
- **Version tracking** - Track migration progress
